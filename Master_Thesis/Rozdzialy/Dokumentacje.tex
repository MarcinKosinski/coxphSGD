\chapter{Wykorzystane narzędzia, dokumentacja i kody pakietu $\mathcal{R}$ użyte w pracy}\label{docCoxSGD}

W pracy wykorzystano środowisko statystyczne $\mathcal{R}$ \citep{programikr, biecek1, gagol1} do implementacji algorytmów, przeprowadzenia symulacji oraz wykonania analizy danych genomicznych. Do przetwarzania danych wykorzystano pakiety \texttt{dplyr} \citep{dplyr}, \texttt{tidyr} \citep{tidyr}, \texttt{reshape2} \citep{reshape2} oraz \texttt{data.table} \citep{data.table}. Do tworzenia dokumentacji oraz struktury pakietu \texttt{coxphSGD} \citep{kosa0} użyto pakietów \texttt{roxygen2} \citep{roxygen2}, \texttt{rmarkdown} \citep{rmarkdown}, \texttt{knitr} \citep{knitr1, knitr2, knitr3}, \texttt{assertthat} \citep{assertthat} oraz pakietu \texttt{rlp} \citep{rlp}. Przejrzystość kodu wspierał pakiet \texttt{magrittr} \citep{magrittr}, zaś do tworzenia wizualizacji wykorzystano pakiet \texttt{ggplot2} \citep{ggplot2}. Dane do analizy pobrano dzięki pakietowi \texttt{RTCGA} \citep{kosa1}) oraz umieszczono je w pakietach \texttt{RTCGA.clinical} \citep{kosa2} oraz \texttt{RTCGA.mutations} \citep{kosa3}. Archiwizowanie wyników analizy możliwe było dzięki pakietowi \texttt{archivist} \citep{archivist}.

\section{Model proporcjonalnych hazardów Coxa}\label{coxKody123}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{checkArguments <-}\StringTok{ }\NormalTok{function(formula, data, learningRates,}
                             \NormalTok{beta_0, epsilon) \{}
  \KeywordTok{assert_that}\NormalTok{(}\KeywordTok{is.list}\NormalTok{(data) &}\StringTok{ }\KeywordTok{length}\NormalTok{(data) >}\StringTok{ }\DecValTok{0}\NormalTok{)}
  \KeywordTok{assert_that}\NormalTok{(}\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{lapply}\NormalTok{(data, ncol)))) ==}\StringTok{ }\DecValTok{1}\NormalTok{)}
  \KeywordTok{assert_that}\NormalTok{(}\KeywordTok{is.function}\NormalTok{(learningRates))}
  \KeywordTok{assert_that}\NormalTok{(}\KeywordTok{is.numeric}\NormalTok{(epsilon, beta_0))}
  \NormalTok{if (}\KeywordTok{length}\NormalTok{(beta_0) ==}\StringTok{ }\DecValTok{1}\NormalTok{) \{}
    \NormalTok{beta_0 <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(beta_0, }\KeywordTok{as.character}\NormalTok{(formula)[}\DecValTok{3}\NormalTok{] %>%}
\StringTok{                    }\KeywordTok{strsplit}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{+"}\NormalTok{) %>%}
\StringTok{                    }\NormalTok{unlist %>%}
\StringTok{                    }\NormalTok{length)}
  \NormalTok{\}}
  \KeywordTok{return}\NormalTok{(beta_0)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}


\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prepareBatch <-}\StringTok{ }\NormalTok{function(formula, data) \{}
  \CommentTok{# Parameter identification as in  `survival::coxph()`.}
  \NormalTok{Call <-}\StringTok{ }\KeywordTok{match.call}\NormalTok{()}
  \NormalTok{indx <-}\StringTok{ }\KeywordTok{match}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"formula"}\NormalTok{, }\StringTok{"data"}\NormalTok{),}
                \KeywordTok{names}\NormalTok{(Call), }\DataTypeTok{nomatch =} \DecValTok{0}\NormalTok{)}
  \NormalTok{if (indx[}\DecValTok{1}\NormalTok{] ==}\StringTok{ }\DecValTok{0}\NormalTok{) }
      \KeywordTok{stop}\NormalTok{(}\StringTok{"A formula argument is required"}\NormalTok{)}
  \NormalTok{temp <-}\StringTok{ }\NormalTok{Call[}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, indx)]}
  \NormalTok{temp[[}\DecValTok{1}\NormalTok{]] <-}\StringTok{ }\KeywordTok{as.name}\NormalTok{(}\StringTok{"model.frame"}\NormalTok{)}
  
  \NormalTok{mf <-}\StringTok{ }\KeywordTok{eval}\NormalTok{(temp, }\KeywordTok{parent.frame}\NormalTok{())}
  \NormalTok{Y <-}\StringTok{ }\KeywordTok{model.extract}\NormalTok{(mf, }\StringTok{"response"}\NormalTok{)}
  
  \NormalTok{if (!}\KeywordTok{inherits}\NormalTok{(Y, }\StringTok{"Surv"}\NormalTok{)) }
      \KeywordTok{stop}\NormalTok{(}\StringTok{"Response must be a survival object"}\NormalTok{)}
  \NormalTok{type <-}\StringTok{ }\KeywordTok{attr}\NormalTok{(Y, }\StringTok{"type"}\NormalTok{)}
  
  \NormalTok{if (type !=}\StringTok{ "right"} \NormalTok{&&}\StringTok{ }\NormalTok{type !=}\StringTok{ "counting"}\NormalTok{) }
      \KeywordTok{stop}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"Cox model doesn't support }\CharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, type, }\StringTok{"}\CharTok{\textbackslash{}"}\StringTok{ survival data"}\NormalTok{, }
          \DataTypeTok{sep =} \StringTok{""}\NormalTok{))}
  \CommentTok{# collect times, status, variables and reorder samples }
  \CommentTok{# to make the algorithm more clear to read and track}
  \KeywordTok{cbind}\NormalTok{(}\DataTypeTok{event =} \KeywordTok{unclass}\NormalTok{(Y)[,}\DecValTok{2}\NormalTok{], }\CommentTok{# 1 indicates event, 0 indicates cens}
        \DataTypeTok{times =} \KeywordTok{unclass}\NormalTok{(Y)[,}\DecValTok{1}\NormalTok{],}
        \NormalTok{mf[, -}\DecValTok{1}\NormalTok{]) %>%}
\StringTok{    }\KeywordTok{arrange}\NormalTok{(times) }
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coxph_loglik <-}\StringTok{ }\NormalTok{function(beta, formula, data) \{}
  \KeywordTok{coxph}\NormalTok{(formula, }\DataTypeTok{init=}\NormalTok{beta, }\DataTypeTok{control=}\KeywordTok{list}\NormalTok{(}\StringTok{'iter.max'}\NormalTok{=}\DecValTok{0}\NormalTok{), }\DataTypeTok{data =}\NormalTok{data)$loglik[}\DecValTok{2}\NormalTok{]}
\NormalTok{\}}
\NormalTok{calculate_outer_cox_3 <-}\StringTok{ }\NormalTok{function(dCox)\{}
  \NormalTok{## contours}
  \NormalTok{outer_res <-}\StringTok{ }\KeywordTok{outer}\NormalTok{(}\KeywordTok{seq}\NormalTok{(-}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{),}
                     \KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{),}
                     \KeywordTok{Vectorize}\NormalTok{( function(beta1,beta2)\{}
                       \KeywordTok{coxph_loglik}\NormalTok{(}\DataTypeTok{beta=}\KeywordTok{c}\NormalTok{(beta1,beta2), }\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\DecValTok{-1}\NormalTok{, dCox)}
                     \NormalTok{\} )}
  \NormalTok{)}
  \NormalTok{outer_res_melted <-}\StringTok{ }\KeywordTok{melt}\NormalTok{(outer_res)}
  \NormalTok{outer_res_melted$Var1 <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(outer_res_melted$Var1)}
  \KeywordTok{levels}\NormalTok{(outer_res_melted$Var1) <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seq}\NormalTok{(-}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{))}
  \NormalTok{outer_res_melted$Var2 <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(outer_res_melted$Var2)}
  \KeywordTok{levels}\NormalTok{(outer_res_melted$Var2) <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{))}
  \NormalTok{outer_res_melted$Var1 <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(outer_res_melted$Var1))}
  \NormalTok{outer_res_melted$Var2 <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(outer_res_melted$Var2))}
  \KeywordTok{return}\NormalTok{(outer_res_melted)}
\NormalTok{\}}



\KeywordTok{calculate_outer_cox_3}\NormalTok{(dCox) ->}\StringTok{ }\NormalTok{outerCox}
\NormalTok{simulateCoxSGD <-}\StringTok{ }\NormalTok{function(}\DataTypeTok{dCox =} \NormalTok{dCox, }\DataTypeTok{learningRates =} \NormalTok{function(x)\{}\DecValTok{1}\NormalTok{/x\},}
                      \DataTypeTok{epsilon =} \FloatTok{1e-03}\NormalTok{, }\DataTypeTok{beta_0 =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{), }\DataTypeTok{max.iter =} \DecValTok{100}\NormalTok{)\{}

  \KeywordTok{sample}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{90}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{^}\DecValTok{4}\NormalTok{, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{) ->}\StringTok{ }\NormalTok{group}
  \KeywordTok{split}\NormalTok{(dCox, group) ->}\StringTok{ }\NormalTok{dCox_splitted}
  \KeywordTok{coxphSGD}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox_splitted,}
           \DataTypeTok{epsilon =} \NormalTok{epsilon, }\DataTypeTok{learningRates =} \NormalTok{learningRates, }
           \DataTypeTok{beta_0 =} \NormalTok{beta_0, }\DataTypeTok{max.iter =} \NormalTok{max.iter*}\DecValTok{90}\NormalTok{) ->}\StringTok{ }\NormalTok{estimates}

  \KeywordTok{sample}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{60}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{^}\DecValTok{4}\NormalTok{, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{) ->}\StringTok{ }\NormalTok{group}
  \KeywordTok{split}\NormalTok{(dCox, group) ->}\StringTok{ }\NormalTok{dCox_splitted}
  \KeywordTok{coxphSGD}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox_splitted,}
           \DataTypeTok{epsilon =} \NormalTok{epsilon, }\DataTypeTok{learningRates =} \NormalTok{learningRates,}
           \DataTypeTok{beta_0 =} \NormalTok{beta_0, }\DataTypeTok{max.iter =} \NormalTok{max.iter*}\DecValTok{60}\NormalTok{) ->}\StringTok{ }\NormalTok{estimates2}

  \KeywordTok{sample}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{120}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{^}\DecValTok{4}\NormalTok{, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{) ->}\StringTok{ }\NormalTok{group}
  \KeywordTok{split}\NormalTok{(dCox, group) ->}\StringTok{ }\NormalTok{dCox_splitted}
  \KeywordTok{coxphSGD}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox_splitted,}
           \DataTypeTok{epsilon =} \NormalTok{epsilon, }\DataTypeTok{learningRates =} \NormalTok{learningRates,}
           \DataTypeTok{beta_0 =} \NormalTok{beta_0, }\DataTypeTok{max.iter =} \NormalTok{max.iter*}\DecValTok{120}\NormalTok{) ->}\StringTok{ }\NormalTok{estimates3}

  \KeywordTok{sample}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{200}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{^}\DecValTok{4}\NormalTok{, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{) ->}\StringTok{ }\NormalTok{group}
  \KeywordTok{split}\NormalTok{(dCox, group) ->}\StringTok{ }\NormalTok{dCox_splitted}
  \KeywordTok{coxphSGD}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox_splitted,}
           \DataTypeTok{epsilon =} \NormalTok{epsilon, }\DataTypeTok{learningRates =} \NormalTok{learningRates,}
           \DataTypeTok{beta_0 =} \NormalTok{beta_0, }\DataTypeTok{max.iter =} \NormalTok{max.iter*}\DecValTok{200}\NormalTok{) ->}\StringTok{ }\NormalTok{estimates4}


  \KeywordTok{sample}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{30}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{^}\DecValTok{4}\NormalTok{, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{) ->}\StringTok{ }\NormalTok{group}
  \KeywordTok{split}\NormalTok{(dCox, group) ->}\StringTok{ }\NormalTok{dCox_splitted}
  \KeywordTok{coxphSGD}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox_splitted,}
           \DataTypeTok{epsilon =} \NormalTok{epsilon, }\DataTypeTok{learningRates =} \NormalTok{learningRates,}
           \DataTypeTok{beta_0 =} \NormalTok{beta_0, }\DataTypeTok{max.iter =} \NormalTok{max.iter*}\DecValTok{30}\NormalTok{) ->}\StringTok{ }\NormalTok{estimates5}


  \KeywordTok{t}\NormalTok{(}\KeywordTok{simplify2array}\NormalTok{(estimates$coefficients)) %>%}
\StringTok{    }\KeywordTok{as.data.frame}\NormalTok{() ->}\StringTok{ }\NormalTok{df1}
  \KeywordTok{t}\NormalTok{(}\KeywordTok{simplify2array}\NormalTok{(estimates2$coefficients)) %>%}
\StringTok{    }\KeywordTok{as.data.frame}\NormalTok{() ->}\StringTok{ }\NormalTok{df2}
  \KeywordTok{t}\NormalTok{(}\KeywordTok{simplify2array}\NormalTok{(estimates3$coefficients)) %>%}
\StringTok{    }\KeywordTok{as.data.frame}\NormalTok{() ->}\StringTok{ }\NormalTok{df3}
  \KeywordTok{t}\NormalTok{(}\KeywordTok{simplify2array}\NormalTok{(estimates4$coefficients)) %>%}
\StringTok{    }\KeywordTok{as.data.frame}\NormalTok{() ->}\StringTok{ }\NormalTok{df4}
  \KeywordTok{t}\NormalTok{(}\KeywordTok{simplify2array}\NormalTok{(estimates5$coefficients)) %>%}
\StringTok{    }\KeywordTok{as.data.frame}\NormalTok{() ->}\StringTok{ }\NormalTok{df5}

  \NormalTok{df1 %>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{version =} \KeywordTok{paste}\NormalTok{(}\StringTok{"90 batches,"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(df1), }\StringTok{" steps"}\NormalTok{)) %>%}
\StringTok{    }\KeywordTok{bind_rows}\NormalTok{(df2 %>%}
\StringTok{                }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{version =} \KeywordTok{paste}\NormalTok{(}\StringTok{"60 batches,"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(df2), }\StringTok{" steps"}\NormalTok{))) %>%}
\StringTok{    }\KeywordTok{bind_rows}\NormalTok{(df3 %>%}
\StringTok{                }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{version =} \KeywordTok{paste}\NormalTok{(}\StringTok{"120 batches,"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(df3), }\StringTok{" steps"}\NormalTok{))) %>%}
\StringTok{    }\KeywordTok{bind_rows}\NormalTok{(df4 %>%}
\StringTok{                }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{version =} \KeywordTok{paste}\NormalTok{(}\StringTok{"200 batches,"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(df4), }\StringTok{" steps"}\NormalTok{))) %>%}
\StringTok{    }\KeywordTok{bind_rows}\NormalTok{(df5 %>%}
\StringTok{                }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{version =} \KeywordTok{paste}\NormalTok{(}\StringTok{"30 batches,"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(df5), }\StringTok{" steps"}\NormalTok{))) ->}\StringTok{ }\NormalTok{d2ggplot}

  \KeywordTok{return}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\DataTypeTok{d2ggplot =} \NormalTok{d2ggplot, }\DataTypeTok{est1 =} \NormalTok{estimates, }\DataTypeTok{est2 =} \NormalTok{estimates2,}
              \DataTypeTok{est3 =} \NormalTok{estimates3, }\DataTypeTok{est4 =} \NormalTok{estimates4, }\DataTypeTok{est5 =} \NormalTok{estimates5))}

\NormalTok{\}}
\KeywordTok{simulateCoxSGD}\NormalTok{(dCox, }\DataTypeTok{learningRates =} \NormalTok{function(x)\{}\DecValTok{1}\NormalTok{/(}\DecValTok{100}\NormalTok{*}\KeywordTok{sqrt}\NormalTok{(x))\},}
               \DataTypeTok{max.iter =} \DecValTok{10}\NormalTok{, }\DataTypeTok{epsilon =} \FloatTok{1e-5}\NormalTok{) ->}\StringTok{ }\NormalTok{d2ggplot}
\NormalTok{d2ggplot ->}\StringTok{ }\NormalTok{backpack}
\NormalTok{d2ggplot <-}\StringTok{ }\NormalTok{d2ggplot$d2ggplot}
\NormalTok{beta_0 =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)}
\NormalTok{solution =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{)}



\KeywordTok{pdf}\NormalTok{(}\DataTypeTok{file =} \StringTok{"b_0_0_iter_10_e-5_100sqrt_878.pdf"}\NormalTok{, }\DataTypeTok{width =} \DecValTok{10}\NormalTok{, }\DataTypeTok{height =} \DecValTok{10}\NormalTok{)}

\KeywordTok{ggplot}\NormalTok{() +}
\StringTok{  }\KeywordTok{stat_contour}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{outerCox$Var1,}
                   \DataTypeTok{y=}\NormalTok{outerCox$Var2,}
                   \DataTypeTok{z=}\NormalTok{outerCox$value),}
               \DataTypeTok{bins =} \DecValTok{40}\NormalTok{, }\DataTypeTok{alpha =} \FloatTok{0.25}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_path}\NormalTok{(}\KeywordTok{aes}\NormalTok{(d2ggplot$V1, d2ggplot$V2, }\DataTypeTok{group =} \NormalTok{d2ggplot$version,}
                \DataTypeTok{colour =} \NormalTok{d2ggplot$version), }\DataTypeTok{size =} \DecValTok{1}\NormalTok{) +}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{20}\NormalTok{) +}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{panel.border =} \KeywordTok{element_blank}\NormalTok{(),}
        \DataTypeTok{legend.key =} \KeywordTok{element_blank}\NormalTok{(), }\DataTypeTok{legend.position =} \StringTok{"top"}\NormalTok{) +}
\StringTok{  }\KeywordTok{scale_colour_brewer}\NormalTok{(}\DataTypeTok{palette=}\StringTok{"Dark2"}\NormalTok{, }\DataTypeTok{name =} \StringTok{'Algorithm }\CharTok{\textbackslash{}n}\StringTok{ & Steps'}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \NormalTok{beta_0[}\DecValTok{1}\NormalTok{], }\DataTypeTok{y =} \NormalTok{beta_0[}\DecValTok{2}\NormalTok{]), }\DataTypeTok{col =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}\NormalTok{, }\DataTypeTok{shape =} \DecValTok{17}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \NormalTok{solution[}\DecValTok{1}\NormalTok{], }\DataTypeTok{y =} \NormalTok{solution[}\DecValTok{2}\NormalTok{]), }\DataTypeTok{col =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}\NormalTok{, }\DataTypeTok{shape =} \DecValTok{15}\NormalTok{) +}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{summary}\NormalTok{(}\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox))$coeff[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{],}
                 \DataTypeTok{y =} \KeywordTok{summary}\NormalTok{(}\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status)~x}\FloatTok{.1}\NormalTok{+x}\FloatTok{.2}\NormalTok{, }\DataTypeTok{data =} \NormalTok{dCox))$coeff[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]),}
             \DataTypeTok{col =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}\NormalTok{, }\DataTypeTok{shape =} \DecValTok{13}\NormalTok{) +}
\StringTok{  }\KeywordTok{xlab}\NormalTok{(}\StringTok{"X1"}\NormalTok{) +}\StringTok{ }\KeywordTok{ylab}\NormalTok{(}\StringTok{"X2"}\NormalTok{) +}
\StringTok{  }\KeywordTok{guides}\NormalTok{(}\DataTypeTok{col =} \KeywordTok{guide_legend}\NormalTok{(}\DataTypeTok{ncol =} \DecValTok{3}\NormalTok{))}

\KeywordTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\section{Dokumentacja pakietu \texttt{coxphSGD}}

%dokumentacja funkcji coxphSGD
\includepdf[pages=-]{coxDoc8.pdf}
%\chapter{Dokumentacja pakietu RTCGA}
%\includepdf[pages=-]{RTCGA.pdf}

\section{Analiza wpływu mutacji genów na czas życia}\label{dod:analiza}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{extractSurvival <-}\StringTok{ }\NormalTok{function(cohorts)\{}
  
  \NormalTok{survivalData <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
  \NormalTok{for(i in cohorts)\{}
    \KeywordTok{get}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(i, }\StringTok{".clinical"}\NormalTok{), }\DataTypeTok{envir =} \NormalTok{.GlobalEnv) %>%}
\StringTok{                }\KeywordTok{select}\NormalTok{(patient.bcr_patient_barcode,}
                             \NormalTok{patient.vital_status,}
                             \NormalTok{patient.days_to_last_followup,}
                             \NormalTok{patient.days_to_death ) %>%}
\StringTok{                }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{bcr_patient_barcode =} \KeywordTok{toupper}\NormalTok{(patient.bcr_patient_barcode),}
                       \DataTypeTok{patient.vital_status =} \KeywordTok{ifelse}\NormalTok{(patient.vital_status %>%}
\StringTok{                                                 }\KeywordTok{as.character}\NormalTok{() ==}\StringTok{"dead"}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{),}
                   \DataTypeTok{barcode =} \NormalTok{patient.bcr_patient_barcode %>%}
\StringTok{                                     }\KeywordTok{as.character}\NormalTok{(),}
                 \DataTypeTok{times =} \KeywordTok{ifelse}\NormalTok{( !}\KeywordTok{is.na}\NormalTok{(patient.days_to_last_followup),}
                      \NormalTok{patient.days_to_last_followup %>%}
\StringTok{                        }\KeywordTok{as.character}\NormalTok{() %>%}
\StringTok{                        }\KeywordTok{as.numeric}\NormalTok{(),}
               \NormalTok{patient.days_to_death %>%}
\StringTok{                        }\KeywordTok{as.character}\NormalTok{() %>%}
\StringTok{                        }\KeywordTok{as.numeric}\NormalTok{() )}
                     \NormalTok{) %>%}
\StringTok{   }\KeywordTok{filter}\NormalTok{(!}\KeywordTok{is.na}\NormalTok{(times)) ->}\StringTok{ }\NormalTok{survivalData[[i]]}
  
  
  \NormalTok{\}}
  \KeywordTok{do.call}\NormalTok{(rbind,survivalData) %>%}
\StringTok{    }\KeywordTok{select}\NormalTok{(bcr_patient_barcode, patient.vital_status, times) %>%}
\StringTok{    }\NormalTok{unique  }

\NormalTok{\}}

\NormalTok{extractCohortIntersection <-}\StringTok{ }\NormalTok{function()\{}
  
  \KeywordTok{data}\NormalTok{(}\DataTypeTok{package =} \StringTok{"RTCGA.mutations"}\NormalTok{)$results[,}\DecValTok{3}\NormalTok{] %>%}
\StringTok{    }\KeywordTok{gsub}\NormalTok{(}\StringTok{".mutations"}\NormalTok{, }\StringTok{""}\NormalTok{, }\DataTypeTok{x =} \NormalTok{.) ->}\StringTok{ }\NormalTok{mutations_data}
  \KeywordTok{data}\NormalTok{(}\DataTypeTok{package =} \StringTok{"RTCGA.clinical"}\NormalTok{)$results[,}\DecValTok{3}\NormalTok{] %>%}
\StringTok{    }\KeywordTok{gsub}\NormalTok{(}\StringTok{".clinical"}\NormalTok{, }\StringTok{""}\NormalTok{, }\DataTypeTok{x =} \NormalTok{.) ->}\StringTok{ }\NormalTok{clinical_data}
  
  \KeywordTok{intersect}\NormalTok{(mutations_data, clinical_data)}
\NormalTok{\}}

\NormalTok{prepareForumlaSGD <-}\StringTok{ }\NormalTok{function(coxData)\{}
  \KeywordTok{as.formula}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"Surv(times, patient.vital_status) ~ "}\NormalTok{,}
                   \KeywordTok{paste}\NormalTok{(}\KeywordTok{names}\NormalTok{(coxData)[-}\KeywordTok{c}\NormalTok{(}\DecValTok{1092}\NormalTok{, }\DecValTok{1093}\NormalTok{)],}
                         \DataTypeTok{collapse=}\StringTok{"+"}\NormalTok{), }\DataTypeTok{collapse =} \StringTok{""}\NormalTok{))}
\NormalTok{\}}

\NormalTok{extractMutations <-}\StringTok{ }\NormalTok{function(cohorts, prc)\{}
  \NormalTok{mutationsData <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
  \NormalTok{for(i in cohorts)\{}
    \KeywordTok{get}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(i, }\StringTok{".mutations"}\NormalTok{), }\DataTypeTok{envir =} \NormalTok{.GlobalEnv) %>%}
\StringTok{      }\KeywordTok{select}\NormalTok{(Hugo_Symbol, bcr_patient_barcode) %>%}
\StringTok{      }\KeywordTok{filter}\NormalTok{(}\KeywordTok{nchar}\NormalTok{(bcr_patient_barcode)==}\DecValTok{15}\NormalTok{) %>%}
\StringTok{      }\KeywordTok{filter}\NormalTok{(}\KeywordTok{substr}\NormalTok{(bcr_patient_barcode, }\DecValTok{14}\NormalTok{, }\DecValTok{15}\NormalTok{)==}\StringTok{"01"}\NormalTok{) %>%}
\StringTok{      }\NormalTok{unique ->}\StringTok{ }\NormalTok{mutationsData[[i]]}
  \NormalTok{\}}
  \KeywordTok{do.call}\NormalTok{(rbind,mutationsData) %>%}\StringTok{ }\NormalTok{unique ->}\StringTok{ }\NormalTok{mutationsData}
  \NormalTok{mutationsData %>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(Hugo_Symbol) %>%}
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{count =} \KeywordTok{n}\NormalTok{()) %>%}
\StringTok{    }\KeywordTok{arrange}\NormalTok{(}\KeywordTok{desc}\NormalTok{(count)) %>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{count_prc =} \NormalTok{count/}\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(mutationsData$bcr_patient_barcode))) %>%}
\StringTok{    }\KeywordTok{filter_}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"count_prc > "}\NormalTok{,prc)) %>%}
\StringTok{    }\KeywordTok{select}\NormalTok{(Hugo_Symbol) %>%}
\StringTok{    }\NormalTok{unlist ->}\StringTok{ }\NormalTok{topGenes}
  \NormalTok{mutationsData %>%}
\StringTok{    }\KeywordTok{filter}\NormalTok{(Hugo_Symbol %in%}\StringTok{ }\NormalTok{topGenes) ->}\StringTok{ }\NormalTok{mutationsData_top}
  \NormalTok{mutationsData_top %>%}
\StringTok{    }\NormalTok{dplyr::}\KeywordTok{group_by}\NormalTok{(bcr_patient_barcode) %>%}
\StringTok{    }\NormalTok{dplyr::}\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{count =} \KeywordTok{n}\NormalTok{()) %>%}
\StringTok{    }\KeywordTok{group_by}\NormalTok{(count) %>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total =} \KeywordTok{n}\NormalTok{()) %>%}
\StringTok{    }\KeywordTok{arrange}\NormalTok{(}\KeywordTok{desc}\NormalTok{(count))}
  \KeywordTok{as.data.table}\NormalTok{(mutationsData_top) ->}\StringTok{ }\NormalTok{mutationsData_top_DT}
  \KeywordTok{dcast.data.table}\NormalTok{(mutationsData_top_DT, bcr_patient_barcode ~}\StringTok{ }\NormalTok{Hugo_Symbol, }\DataTypeTok{fill =} \DecValTok{0}\NormalTok{) %>%}
\StringTok{    }\NormalTok{as.data.frame ->}\StringTok{ }\NormalTok{mutationsData_top_dcasted}
  \NormalTok{mutationsData_top_dcasted[,-}\DecValTok{1}\NormalTok{][mutationsData_top_dcasted[,-}\DecValTok{1}\NormalTok{] !=}\StringTok{ "0"}\NormalTok{] <-}\StringTok{ }\DecValTok{1}
 \NormalTok{mutationsData_top_dcasted ->}\StringTok{ }\NormalTok{result}
  \KeywordTok{names}\NormalTok{(result) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{names}\NormalTok{(result),}\DataTypeTok{pattern =} \StringTok{"-"}\NormalTok{,  }\DataTypeTok{replacement =} \StringTok{""}\NormalTok{)}
  \NormalTok{result}
\NormalTok{\}}

\NormalTok{prepareCoxDataSplit <-}\StringTok{ }\NormalTok{function(mutationsData, survivalData, groups, }\DataTypeTok{seed =} \DecValTok{4561}\NormalTok{)\{}
  \NormalTok{mutationsData %>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{bcr_patient_barcode =} \KeywordTok{substr}\NormalTok{(bcr_patient_barcode,}\DecValTok{1}\NormalTok{,}\DecValTok{12}\NormalTok{)) %>%}
\StringTok{  }\KeywordTok{left_join}\NormalTok{(survivalData,}
            \DataTypeTok{by =} \StringTok{"bcr_patient_barcode"}\NormalTok{) ->}\StringTok{ }\NormalTok{coxData}
  \NormalTok{coxData <-}\StringTok{ }\NormalTok{coxData[, -}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)]}
  \KeywordTok{apply}\NormalTok{(coxData[,-}\KeywordTok{c}\NormalTok{(}\DecValTok{1092}\NormalTok{, }\DecValTok{1093}\NormalTok{)], }\DataTypeTok{MARGIN =} \DecValTok{2}\NormalTok{,function(x)\{}
    \KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(x))}
  \NormalTok{\}) ->}\StringTok{ }\NormalTok{coxData[,-}\KeywordTok{c}\NormalTok{(}\DecValTok{1092}\NormalTok{, }\DecValTok{1093}\NormalTok{)]}
  \KeywordTok{set.seed}\NormalTok{(seed)}
  \KeywordTok{sample}\NormalTok{(groups, }\DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{size =} \DecValTok{6459}\NormalTok{) ->}\StringTok{ }\NormalTok{groups}
  \KeywordTok{split}\NormalTok{(coxData, groups) coxData_split}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}


\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model_1_over_t$coefficients[}\KeywordTok{c}\NormalTok{(}\DecValTok{98}\NormalTok{, }\DecValTok{196}\NormalTok{, }\DecValTok{294}\NormalTok{, }\DecValTok{392}\NormalTok{, }\DecValTok{490}\NormalTok{)] ->}\StringTok{ }\NormalTok{coeffs_1_overt}
\KeywordTok{do.call}\NormalTok{(rbind, coeffs_1_overt) %>%}
\StringTok{  }\NormalTok{as.data.frame %>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{epoka =} \DecValTok{1}\NormalTok{:}\DecValTok{5}\NormalTok{) %>%}
\StringTok{  }\NormalTok{tidyr::}\KeywordTok{gather}\NormalTok{(}\DataTypeTok{key=}\NormalTok{epoka) ->gat}
\KeywordTok{names}\NormalTok{(gat)[}\DecValTok{2}\NormalTok{]<-}\StringTok{ "gen"}
\KeywordTok{library}\NormalTok{(ggplot2)}
\NormalTok{gat %>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(value)) +}\StringTok{ }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{fill=}\DecValTok{4}\NormalTok{, }\DataTypeTok{col =} \DecValTok{1}\NormalTok{, }\DataTypeTok{binwidth =}  \FloatTok{0.01}\NormalTok{) +}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(epoka~.) +}
\StringTok{  }\KeywordTok{theme_classic}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{15}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'liczność'}\NormalTok{) +}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\StringTok{'wartości współczynników modelu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Histogramy wartości współczynników modelu po kolejnych epokach'}\NormalTok{) +}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(-}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.5}\NormalTok{)) ->}\StringTok{ }\NormalTok{fig1}


\NormalTok{model_1_over_50sqrt_t$coefficients[}\KeywordTok{c}\NormalTok{(}\DecValTok{98}\NormalTok{, }\DecValTok{196}\NormalTok{, }\DecValTok{294}\NormalTok{, }\DecValTok{392}\NormalTok{, }\DecValTok{490}\NormalTok{)] ->}\StringTok{ }\NormalTok{coeffs_over_50sqrt_t}
\KeywordTok{do.call}\NormalTok{(rbind, coeffs_over_50sqrt_t) %>%}
\StringTok{  }\NormalTok{as.data.frame %>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{epoka =} \DecValTok{1}\NormalTok{:}\DecValTok{5}\NormalTok{) %>%}
\StringTok{  }\NormalTok{tidyr::}\KeywordTok{gather}\NormalTok{(}\DataTypeTok{key=}\NormalTok{epoka) ->gat2}
\KeywordTok{names}\NormalTok{(gat2)[}\DecValTok{2}\NormalTok{]<-}\StringTok{ "gen"}
\KeywordTok{library}\NormalTok{(ggplot2)}
\NormalTok{gat2 %>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(value)) +}\StringTok{ }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{fill=}\DecValTok{5}\NormalTok{, }\DataTypeTok{col =} \DecValTok{1}\NormalTok{, }\DataTypeTok{binwidth =}  \FloatTok{0.01}\NormalTok{) +}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(epoka~.) +}
\StringTok{  }\KeywordTok{theme_classic}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{15}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'liczność'}\NormalTok{) +}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\StringTok{'wartości współczynników modelu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Histogramy wartości współczynników modelu po kolejnych epokach'}\NormalTok{) +}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(-}\FloatTok{0.25}\NormalTok{,}\FloatTok{0.25}\NormalTok{)) ->}\StringTok{ }\NormalTok{fig2}

\NormalTok{model_1_over_100sqrt_t$coefficients[}\KeywordTok{c}\NormalTok{(}\DecValTok{98}\NormalTok{, }\DecValTok{196}\NormalTok{, }\DecValTok{294}\NormalTok{, }\DecValTok{392}\NormalTok{, }\DecValTok{490}\NormalTok{)] ->}\StringTok{ }\NormalTok{coeffs_over_100sqrt_t}
\KeywordTok{do.call}\NormalTok{(rbind, coeffs_over_100sqrt_t) %>%}
\StringTok{  }\NormalTok{as.data.frame %>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{epoka =} \DecValTok{1}\NormalTok{:}\DecValTok{5}\NormalTok{) %>%}
\StringTok{  }\NormalTok{tidyr::}\KeywordTok{gather}\NormalTok{(}\DataTypeTok{key=}\NormalTok{epoka) ->gat3}
\KeywordTok{names}\NormalTok{(gat3)[}\DecValTok{2}\NormalTok{]<-}\StringTok{ "gen"}
\NormalTok{gat3 %>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(value)) +}\StringTok{ }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{fill=}\DecValTok{6}\NormalTok{, }\DataTypeTok{col =} \DecValTok{1}\NormalTok{, }\DataTypeTok{binwidth =}  \FloatTok{0.01}\NormalTok{) +}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(epoka~.) +}
\StringTok{  }\KeywordTok{theme_classic}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{15}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'liczność'}\NormalTok{) +}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\StringTok{'wartości współczynników modelu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Histogramy wartości współczynników modelu po kolejnych epokach'}\NormalTok{) +}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(-}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{)) ->}\StringTok{ }\NormalTok{fig3}



\NormalTok{gat %>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{model =} \StringTok{"model1"}\NormalTok{) %>%}
\StringTok{  }\KeywordTok{bind_rows}\NormalTok{(gat2 %>%}
\StringTok{              }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{model =} \StringTok{"model2"}\NormalTok{)) %>%}\StringTok{ }
\StringTok{  }\KeywordTok{bind_rows}\NormalTok{(gat3 %>%}
\StringTok{              }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{model =} \StringTok{"model3"}\NormalTok{)) %>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(value)) +}\StringTok{ }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{fill=}\DecValTok{4}\NormalTok{, }\DataTypeTok{col =} \DecValTok{1}\NormalTok{, }\DataTypeTok{binwidth =} \FloatTok{0.001}\NormalTok{) +}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(epoka~model) +}
\StringTok{  }\KeywordTok{theme_classic}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{15}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'liczność'}\NormalTok{) +}\StringTok{ }\KeywordTok{xlab}\NormalTok{(}\StringTok{'wartość współczynnika modelu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Histogramy wartości współczynników modelu po kolejnych epokach'}\NormalTok{) ->}\StringTok{ }\NormalTok{fig4}

\KeywordTok{do.call}\NormalTok{(rbind, coeffs_over_100sqrt_t) %>%}\StringTok{ }\NormalTok{t %>%}\StringTok{  }\NormalTok{as.data.frame ->}\StringTok{ }\NormalTok{model3}
\KeywordTok{do.call}\NormalTok{(rbind, coeffs_over_50sqrt_t) %>%}\StringTok{ }\NormalTok{t %>%}\StringTok{  }\NormalTok{as.data.frame ->}\StringTok{ }\NormalTok{model2}
\KeywordTok{do.call}\NormalTok{(rbind, coeffs_1_overt) %>%}\StringTok{ }\NormalTok{t %>%}\StringTok{  }\NormalTok{as.data.frame ->}\StringTok{ }\NormalTok{model1}
\KeywordTok{names}\NormalTok{(model3) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"epoka1"}\NormalTok{, }\StringTok{"epoka2"}\NormalTok{,}\StringTok{"epoka3"}\NormalTok{, }\StringTok{"epoka4"}\NormalTok{, }\StringTok{"epoka5"}\NormalTok{)}
\KeywordTok{names}\NormalTok{(model2) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"epoka1"}\NormalTok{, }\StringTok{"epoka2"}\NormalTok{,}\StringTok{"epoka3"}\NormalTok{, }\StringTok{"epoka4"}\NormalTok{, }\StringTok{"epoka5"}\NormalTok{)}
\KeywordTok{names}\NormalTok{(model1) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"epoka1"}\NormalTok{, }\StringTok{"epoka2"}\NormalTok{,}\StringTok{"epoka3"}\NormalTok{, }\StringTok{"epoka4"}\NormalTok{, }\StringTok{"epoka5"}\NormalTok{)}

\KeywordTok{library}\NormalTok{(GGally)}
\KeywordTok{ggpairs}\NormalTok{(  }\DataTypeTok{title =} \StringTok{'Różnice między współczynnikami w kolejnych epokach'}\NormalTok{,}
          \NormalTok{model1, }
          \DataTypeTok{upper =} \StringTok{"blank"}\NormalTok{,}
          \DataTypeTok{lower =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{continuous =} \StringTok{"points"}\NormalTok{)}
\NormalTok{) ->}\StringTok{ }\NormalTok{fig5 }
\KeywordTok{do.call}\NormalTok{(rbind, model_1_over_t$coefficients) ->}\StringTok{ }\NormalTok{wspolczynniki}
\KeywordTok{qplot}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{491}\NormalTok{,wspolczynniki[ ,}\KeywordTok{which}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(wspolczynniki) ==}\StringTok{ "BRAF"}\NormalTok{)]) +}
\StringTok{  }\KeywordTok{xlab}\NormalTok{(}\StringTok{'Krok algorytmu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'Wartość współczynnika'}\NormalTok{) +}
\StringTok{  }\KeywordTok{theme_minimal}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{20}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Wartości współczynnika genu BRAF'}\NormalTok{) ->}\StringTok{ }\NormalTok{fig8}
\KeywordTok{qplot}\NormalTok{(}\DecValTok{1}\NormalTok{:}\DecValTok{491}\NormalTok{,wspolczynniki[ ,}\KeywordTok{which}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(wspolczynniki) ==}\StringTok{ "EGFR"}\NormalTok{)]) +}
\StringTok{  }\KeywordTok{xlab}\NormalTok{(}\StringTok{'Krok algorytmu'}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{'Wartość współczynnika'}\NormalTok{) +}
\StringTok{  }\KeywordTok{theme_minimal}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{20}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{'Wartości współczynnika genu EGFR'}\NormalTok{) ->}\StringTok{ }\NormalTok{fig9}
\KeywordTok{do.call}\NormalTok{(rbind,testCox) ->}\StringTok{ }\NormalTok{testCox_binded}
\KeywordTok{do.call}\NormalTok{(rbind,trainCox) ->}\StringTok{ }\NormalTok{trainCox_binded}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(survMisc)}
\NormalTok{trainCox_binded %>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(patient.vital_status, times, BRAF, EGFR) %>%}
\StringTok{  }\KeywordTok{survfit}\NormalTok{( }\KeywordTok{Surv}\NormalTok{(times, patient.vital_status) ~}\StringTok{ }\NormalTok{BRAF, }\DataTypeTok{data =} \NormalTok{.) %>%}
\StringTok{  }\NormalTok{survMisc:::}\KeywordTok{autoplot.survfit}\NormalTok{( }\DataTypeTok{titleSize=}\DecValTok{12}\NormalTok{, }\DataTypeTok{type=}\StringTok{"CI"}\NormalTok{, }\DataTypeTok{palette =} \StringTok{"Set1"}\NormalTok{,}
                               \DataTypeTok{alpha =} \FloatTok{0.7}\NormalTok{, }\DataTypeTok{survLineSize=}\DecValTok{2}\NormalTok{,}
 \DataTypeTok{pX =} \FloatTok{0.3}\NormalTok{, }\DataTypeTok{sigP =}\DecValTok{3}\NormalTok{, }\DataTypeTok{title =} \StringTok{"Przeżycie a mutacja genu BRAF"} \NormalTok{) ->}\StringTok{ }\NormalTok{km_plot}

\NormalTok{xlims <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{5000}\NormalTok{)}
\KeywordTok{library}\NormalTok{(ggplot2)}
\NormalTok{km_plot[[}\DecValTok{1}\NormalTok{]] <-}\StringTok{ }\NormalTok{km_plot[[}\DecValTok{1}\NormalTok{]] +}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(xlims[}\DecValTok{1}\NormalTok{],xlims[}\DecValTok{2}\NormalTok{])) +}
\StringTok{  }\KeywordTok{theme_light}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{22}\NormalTok{) }
\NormalTok{km_plot[[}\DecValTok{2}\NormalTok{]] <-}\StringTok{ }\NormalTok{km_plot[[}\DecValTok{2}\NormalTok{]] +}
\StringTok{   }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{xlim =} \NormalTok{xlims)+}
\StringTok{  }\KeywordTok{theme_light}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{22}\NormalTok{) }
\KeywordTok{pdf}\NormalTok{(}\StringTok{"BRAF.pdf"}\NormalTok{, }\DataTypeTok{width =} \DecValTok{10}\NormalTok{, }\DataTypeTok{height =} \DecValTok{8}\NormalTok{)}
\NormalTok{survMisc::}\KeywordTok{autoplot}\NormalTok{(km_plot)}
\KeywordTok{dev.off}\NormalTok{()}

\KeywordTok{do.call}\NormalTok{(rbind,testCox) ->}\StringTok{ }\NormalTok{testCox_binded}
\KeywordTok{do.call}\NormalTok{(rbind,model_1_over_t$coefficients)->}\StringTok{ }\NormalTok{coeffM1}
\KeywordTok{do.call}\NormalTok{(rbind,model_1_over_50sqrt_t$coefficients)->}\StringTok{ }\NormalTok{coeffM2}
\KeywordTok{do.call}\NormalTok{(rbind,model_1_over_100sqrt_t$coefficients)->}\StringTok{ }\NormalTok{coeffM3}
\KeywordTok{library}\NormalTok{(dplyr)}
\NormalTok{coxph_loglik <-}\StringTok{ }\NormalTok{function(beta, batchData )\{}
  \NormalTok{batchData <-}\StringTok{ }\NormalTok{batchData %>%}\StringTok{ }\KeywordTok{arrange}\NormalTok{(-times)}
  \NormalTok{scores <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(batchData[, -}\KeywordTok{c}\NormalTok{(}\DecValTok{1092}\NormalTok{, }\DecValTok{1093}\NormalTok{)], }\DecValTok{1}\NormalTok{, }
                  \NormalTok{function(element) }\KeywordTok{exp}\NormalTok{(element %*%}\StringTok{ }\NormalTok{beta) )}
  \NormalTok{distractor <-}\StringTok{ }\KeywordTok{log}\NormalTok{(}\KeywordTok{cumsum}\NormalTok{(}\NormalTok{scores))}
  
  \KeywordTok{sum}\NormalTok{((}\KeywordTok{as.vector}\NormalTok{(beta%*%}\KeywordTok{t}\NormalTok{(batchData[, -}\KeywordTok{c}\NormalTok{(}\DecValTok{1092}\NormalTok{, }\DecValTok{1093}\NormalTok{)])) -}\StringTok{ }
\StringTok{         }\NormalTok{distractor)*batchData[, }\StringTok{"patient.vital_status"}\NormalTok{])}
  \NormalTok{\}}
\KeywordTok{library}\NormalTok{(pbapply)}
\KeywordTok{pbapply}\NormalTok{(coeffM1, }\DataTypeTok{MARGIN =} \DecValTok{1}\NormalTok{, function(x)\{}
  \KeywordTok{coxph_loglik}\NormalTok{(x, testCox_binded)}
\NormalTok{\}) ->}\StringTok{ }\NormalTok{log_lik_M1}
\KeywordTok{pbapply}\NormalTok{(coeffM2, }\DataTypeTok{MARGIN =} \DecValTok{1}\NormalTok{, function(x)\{}
  \KeywordTok{coxph_loglik}\NormalTok{(x, testCox_binded)}
\NormalTok{\}) ->}\StringTok{ }\NormalTok{log_lik_M2}
\KeywordTok{pbapply}\NormalTok{(coeffM3, }\DataTypeTok{MARGIN =} \DecValTok{1}\NormalTok{, function(x)\{}
  \KeywordTok{coxph_loglik}\NormalTok{(x, testCox_binded)}
\NormalTok{\}) ->}\StringTok{ }\NormalTok{log_lik_M3}
\KeywordTok{library}\NormalTok{(tidyr)}
\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{model1 =} \NormalTok{log_lik_M1,}
           \DataTypeTok{model2 =} \NormalTok{log_lik_M2,}
           \DataTypeTok{model3 =} \NormalTok{log_lik_M3,}
           \DataTypeTok{krok =} \DecValTok{1}\NormalTok{:}\DecValTok{491}\NormalTok{) %>%}
\StringTok{  }\KeywordTok{gather}\NormalTok{(krok) ->}\StringTok{ }\NormalTok{d2viz}
\KeywordTok{names}\NormalTok{(d2viz)[}\DecValTok{2}\NormalTok{]<-}\StringTok{"model"}
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{ggplot}\NormalTok{(d2viz, }\KeywordTok{aes}\NormalTok{(krok, -value, }\DataTypeTok{group =} \NormalTok{model, }\DataTypeTok{col =} \NormalTok{model)) +}\StringTok{ }
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() +}\KeywordTok{scale_color_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Set1"}\NormalTok{) +}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{4000}\NormalTok{)) +}
\StringTok{  }\KeywordTok{theme_light}\NormalTok{() +}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"top"}\NormalTok{) +}
\StringTok{  }\KeywordTok{xlab}\NormalTok{(}\StringTok{"Krok algorytmu"}\NormalTok{) +}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{"log-wiarogodność"}\NormalTok{) +}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Wartości częściowej funkcji log-wiarogodności konstruowanej na zbiorze testowym }
\StringTok{          wśród 3 badanych modeli, w kolejnych krokach algorytmu"}\NormalTok{) ->}\StringTok{ }\NormalTok{fig10}
\end{Highlighting}
\end{Shaded}



\section{Implementacje optymalizacji w regresji logistycznej}\label{kody}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{logitGD <-}\StringTok{ }\NormalTok{function(y, x, }\DataTypeTok{optim.method =} \StringTok{"GDI"}\NormalTok{, }\DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{,}
                    \DataTypeTok{max.iter =} \DecValTok{100}\NormalTok{, }\DataTypeTok{alpha =} \NormalTok{function(t)\{}\DecValTok{1}\NormalTok{/t\}, }\DataTypeTok{beta_0 =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{))\{}
  \KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{length}\NormalTok{(y) ==}\StringTok{ }\KeywordTok{length}\NormalTok{(x) &}\StringTok{ }\NormalTok{optim.method %in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"GDI"}\NormalTok{, }\StringTok{"GDII"}\NormalTok{, }\StringTok{"SGDI"}\NormalTok{)}
            \NormalTok{&}\StringTok{ }\KeywordTok{is.numeric}\NormalTok{(}\KeywordTok{c}\NormalTok{(max.iter, eps, x)) &}\StringTok{ }\KeywordTok{all}\NormalTok{(}\KeywordTok{c}\NormalTok{(eps, max.iter) >}\StringTok{ }\DecValTok{0}\NormalTok{) &}
\StringTok{              }\KeywordTok{is.function}\NormalTok{(alpha))}
  \NormalTok{iter <-}\StringTok{ }\DecValTok{0}
  \NormalTok{err <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
  \NormalTok{err[[iter}\DecValTok{+1}\NormalTok{]] <-}\StringTok{ }\NormalTok{eps}\DecValTok{+1}
  \NormalTok{w_old <-}\StringTok{ }\NormalTok{beta_0}

  \NormalTok{res <-}\KeywordTok{list}\NormalTok{()}
  \NormalTok{while(iter <}\StringTok{ }\NormalTok{max.iter &&}\StringTok{ }\NormalTok{(}\KeywordTok{abs}\NormalTok{(err[[}\KeywordTok{ifelse}\NormalTok{(iter==}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,iter)]]) >}\StringTok{ }\NormalTok{eps))\{}

    \NormalTok{iter <-}\StringTok{ }\NormalTok{iter +}\StringTok{ }\DecValTok{1}
    \NormalTok{if (optim.method ==}\StringTok{ "GDI"}\NormalTok{)\{}
      \NormalTok{w_new <-}\StringTok{ }\NormalTok{w_old +}\StringTok{ }\KeywordTok{alpha}\NormalTok{(iter)*}\KeywordTok{updateWeightsGDI}\NormalTok{(y, x, w_old)}
    \NormalTok{\}}
    \NormalTok{if (optim.method ==}\StringTok{ "GDII"}\NormalTok{)\{}
      \NormalTok{w_new <-}\StringTok{ }\NormalTok{w_old +}\StringTok{ }\KeywordTok{as.vector}\NormalTok{(}\KeywordTok{inverseHessianGDII}\NormalTok{(x, w_old)%*%}
\StringTok{                                   }\KeywordTok{updateWeightsGDI}\NormalTok{(y, x, w_old))}
    \NormalTok{\}}
    \NormalTok{if (optim.method ==}\StringTok{ "SGDI"}\NormalTok{)\{}
      \NormalTok{w_new <-}\StringTok{ }\NormalTok{w_old +}\StringTok{ }\KeywordTok{alpha}\NormalTok{(iter)*}\KeywordTok{updateWeightsSGDI}\NormalTok{(y[iter], x[iter], w_old)}
    \NormalTok{\}}
    \NormalTok{res[[iter]] <-}\StringTok{ }\NormalTok{w_new}
    \NormalTok{err[[iter]] <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{sum}\NormalTok{((w_new -}\StringTok{ }\NormalTok{w_old)^}\DecValTok{2}\NormalTok{))}

    \NormalTok{w_old <-}\StringTok{ }\NormalTok{w_new}

  \NormalTok{\}}
  \KeywordTok{return}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\DataTypeTok{steps =} \KeywordTok{c}\NormalTok{(}\KeywordTok{list}\NormalTok{(beta_0),res), }\DataTypeTok{errors =} \KeywordTok{c}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{)),err)))}
\NormalTok{\}}

\NormalTok{updateWeightsGDI <-}\StringTok{ }\NormalTok{function(y, x, w_old)\{}

  \KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(y-}\KeywordTok{p}\NormalTok{(w_old, x)), }\KeywordTok{sum}\NormalTok{(x*(y-}\KeywordTok{p}\NormalTok{(w_old, x))))}
\NormalTok{\}}

\NormalTok{updateWeightsSGDI <-}\StringTok{ }\NormalTok{function(y_i, x_i, w_old)\{}
  \KeywordTok{c}\NormalTok{(y_i-}\KeywordTok{p}\NormalTok{(w_old, x_i), x_i*(y_i-}\KeywordTok{p}\NormalTok{(w_old, x_i)))}
\NormalTok{\}}

\NormalTok{p <-}\StringTok{ }\NormalTok{function(w_old, x_i)\{}
  \DecValTok{1}\NormalTok{/(}\DecValTok{1}\NormalTok{+}\KeywordTok{exp}\NormalTok{(-w_old[}\DecValTok{1}\NormalTok{]-w_old[}\DecValTok{2}\NormalTok{]*x_i))}
\NormalTok{\}}




\NormalTok{inverseHessianGDII <-}\StringTok{ }\NormalTok{function(x, w_old)\{}
  \KeywordTok{solve}\NormalTok{(}
    \KeywordTok{matrix}\NormalTok{(}\KeywordTok{c}\NormalTok{(}
      \KeywordTok{sum}\NormalTok{(}\KeywordTok{p}\NormalTok{(w_old, x)*(}\DecValTok{1}\NormalTok{-}\KeywordTok{p}\NormalTok{(w_old, x))),}
      \KeywordTok{sum}\NormalTok{(x*}\KeywordTok{p}\NormalTok{(w_old, x)*(}\DecValTok{1}\NormalTok{-}\KeywordTok{p}\NormalTok{(w_old, x))),}
      \KeywordTok{sum}\NormalTok{(x*}\KeywordTok{p}\NormalTok{(w_old, x)*(}\DecValTok{1}\NormalTok{-}\KeywordTok{p}\NormalTok{(w_old, x))),}
      \KeywordTok{sum}\NormalTok{(x*x*}\KeywordTok{p}\NormalTok{(w_old, x)*(}\DecValTok{1}\NormalTok{-}\KeywordTok{p}\NormalTok{(w_old, x)))}
    \NormalTok{),}
    \DataTypeTok{nrow =}\DecValTok{2} \NormalTok{)}
  \NormalTok{)}
\NormalTok{\}}
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{1283}\NormalTok{)}
\NormalTok{x <-}\StringTok{ }\KeywordTok{runif}\NormalTok{(}\DecValTok{10000}\NormalTok{)}
\NormalTok{z <-}\StringTok{ }\DecValTok{2} \NormalTok{+}\StringTok{ }\DecValTok{3}\NormalTok{*x}
\NormalTok{pr <-}\StringTok{ }\DecValTok{1}\NormalTok{/(}\DecValTok{1}\NormalTok{+}\KeywordTok{exp}\NormalTok{(-z))}
\NormalTok{y <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(}\DecValTok{10000}\NormalTok{,}\DecValTok{1}\NormalTok{,pr)}


\NormalTok{global_loglog <-}\StringTok{ }\NormalTok{function(beta1, beta2, xX, yY)\{}
  \KeywordTok{sum}\NormalTok{(yY*(beta2+beta1*xX)-}\KeywordTok{log}\NormalTok{(}\DecValTok{1}\NormalTok{+}\KeywordTok{exp}\NormalTok{(beta2+beta1*xX)))}
\NormalTok{\}}



\NormalTok{calculate_outer <-}\StringTok{ }\NormalTok{function(x, y)\{}
  \NormalTok{## contours}
  \NormalTok{outer_res <-}\StringTok{ }\KeywordTok{outer}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{),}
                     \KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{),}
                     \KeywordTok{Vectorize}\NormalTok{( function(beta1,beta2)\{}
                       \KeywordTok{global_loglog}\NormalTok{(beta1, beta2, }\DataTypeTok{xX =} \NormalTok{x, }\DataTypeTok{yY =} \NormalTok{y)}
                     \NormalTok{\} )}
  \NormalTok{)}

  \NormalTok{outer_res_melted <-}\StringTok{ }\KeywordTok{melt}\NormalTok{(outer_res)}


  \NormalTok{outer_res_melted$Var1 <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(outer_res_melted$Var1)}
  \KeywordTok{levels}\NormalTok{(outer_res_melted$Var1) <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{))}
  \NormalTok{outer_res_melted$Var2 <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(outer_res_melted$Var2)}
  \KeywordTok{levels}\NormalTok{(outer_res_melted$Var2) <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{, }\DataTypeTok{length =} \DecValTok{100}\NormalTok{))}
  \NormalTok{outer_res_melted$Var1 <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(outer_res_melted$Var1))}
  \NormalTok{outer_res_melted$Var2 <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(outer_res_melted$Var2))}
  \KeywordTok{return}\NormalTok{(outer_res_melted)}
\NormalTok{\}}



\KeywordTok{library}\NormalTok{(ggplot2); }\KeywordTok{library}\NormalTok{(ggthemes); }\KeywordTok{library}\NormalTok{(reshape2)}
\NormalTok{graphSGD <-}\StringTok{ }\NormalTok{function(beta, y, x, }\DataTypeTok{seed =} \DecValTok{4561}\NormalTok{, }\DataTypeTok{outerBounds =} \KeywordTok{calculate_outer}\NormalTok{(x,y))\{}
  \KeywordTok{set.seed}\NormalTok{(seed); }\NormalTok{beta <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(beta); } \NormalTok{beta[}\DecValTok{2}\NormalTok{] ->}\StringTok{ }\NormalTok{XX; }\NormalTok{beta[}\DecValTok{1}\NormalTok{] ->}\StringTok{ }\NormalTok{YY}  
  \KeywordTok{logitGD}\NormalTok{(y, x, }\DataTypeTok{optim.method =} \StringTok{"GDI"}\NormalTok{,}\DataTypeTok{beta_0 =} \NormalTok{beta,}
          \DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{, }\DataTypeTok{max.iter =} \DecValTok{10000}\NormalTok{,}
          \DataTypeTok{alpha =} \NormalTok{function(t)\{}\DecValTok{1}\NormalTok{/(}\DecValTok{1000}\NormalTok{*}\KeywordTok{sqrt}\NormalTok{(t))\})$steps ->}\StringTok{ }\NormalTok{GDI.S}
  \KeywordTok{logitGD}\NormalTok{(y, x, }\DataTypeTok{optim.method =} \StringTok{"GDII"}\NormalTok{, }\DataTypeTok{beta_0 =} \NormalTok{beta,}
          \DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{, }\DataTypeTok{max.iter =} \DecValTok{5000}\NormalTok{)$steps ->}\StringTok{ }\NormalTok{GDII}
  \NormalTok{ind2 <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{length}\NormalTok{(y))}
  \KeywordTok{logitGD}\NormalTok{(y[ind2], x[ind2], }\DataTypeTok{optim.method =} \StringTok{"SGDI"}\NormalTok{, }\DataTypeTok{beta_0 =} \NormalTok{beta,}
          \DataTypeTok{max.iter =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{,}
          \DataTypeTok{alpha =} \NormalTok{function(t)\{}\DecValTok{1}\NormalTok{/}\KeywordTok{sqrt}\NormalTok{(t)\})$steps ->}\StringTok{ }\NormalTok{SGDI}\FloatTok{.1}\NormalTok{.S}
  \NormalTok{ind3 <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{length}\NormalTok{(y))}
  \KeywordTok{logitGD}\NormalTok{(y[ind3], x[ind3], }\DataTypeTok{optim.method =} \StringTok{"SGDI"}\NormalTok{, }\DataTypeTok{beta_0 =} \NormalTok{beta,}
          \DataTypeTok{max.iter =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{,}
          \DataTypeTok{alpha =} \NormalTok{function(t)\{}\DecValTok{5}\NormalTok{/}\KeywordTok{sqrt}\NormalTok{(t)\})$steps ->}\StringTok{ }\NormalTok{SGDI}\FloatTok{.5}\NormalTok{.S}
  \NormalTok{ind4 <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{length}\NormalTok{(y))}
  \KeywordTok{logitGD}\NormalTok{(y[ind4], x[ind4], }\DataTypeTok{optim.method =} \StringTok{"SGDI"}\NormalTok{, }\DataTypeTok{beta_0 =} \NormalTok{beta,}
          \DataTypeTok{max.iter =} \DecValTok{10000}\NormalTok{, }\DataTypeTok{eps =} \FloatTok{10e-4}\NormalTok{,}
          \DataTypeTok{alpha =} \NormalTok{function(t)\{}\DecValTok{6}\NormalTok{/}\KeywordTok{sqrt}\NormalTok{(t)\})$steps ->}\StringTok{ }\NormalTok{SGDI}\FloatTok{.6}\NormalTok{.S}
  \KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{c}\NormalTok{(GDI.S, GDII, SGDI}\FloatTok{.1}\NormalTok{.S, SGDI}\FloatTok{.5}\NormalTok{.S, SGDI}\FloatTok{.6}\NormalTok{.S)) ->}\StringTok{ }\NormalTok{coeffs}
  \KeywordTok{unlist}\NormalTok{(}\KeywordTok{lapply}\NormalTok{(}\KeywordTok{list}\NormalTok{(GDI.S, GDII, SGDI}\FloatTok{.1}\NormalTok{.S, SGDI}\FloatTok{.5}\NormalTok{.S, SGDI}\FloatTok{.6}\NormalTok{.S),}
                \NormalTok{length)) ->}\StringTok{ }\NormalTok{algorithm}
  \NormalTok{data2viz <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\KeywordTok{as.data.frame}\NormalTok{(coeffs),}
  \DataTypeTok{algorithm =} \KeywordTok{unlist}\NormalTok{(}\KeywordTok{mapply}\NormalTok{(rep,}
                              \KeywordTok{c}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"GDI"}\NormalTok{, }\KeywordTok{length}\NormalTok{(GDI.S), }\StringTok{"steps"}\NormalTok{),}
                              \KeywordTok{paste}\NormalTok{(}\StringTok{"GDII"}\NormalTok{, }\KeywordTok{length}\NormalTok{(GDII), }\StringTok{"steps"}\NormalTok{),}
                              \KeywordTok{paste}\NormalTok{(}\StringTok{"SGDI.1"}\NormalTok{, }\KeywordTok{length}\NormalTok{(SGDI}\FloatTok{.1}\NormalTok{.S), }\StringTok{"steps"}\NormalTok{),}
                              \KeywordTok{paste}\NormalTok{(}\StringTok{"SGDI.5"}\NormalTok{, }\KeywordTok{length}\NormalTok{(SGDI}\FloatTok{.5}\NormalTok{.S), }\StringTok{"steps"}\NormalTok{),}
                              \KeywordTok{paste}\NormalTok{(}\StringTok{"SGDI.6"}\NormalTok{, }\KeywordTok{length}\NormalTok{(SGDI}\FloatTok{.6}\NormalTok{.S), }\StringTok{"steps"}\NormalTok{)),}
                            \NormalTok{algorithm)))}
  \KeywordTok{names}\NormalTok{(data2viz)[}\DecValTok{1}\NormalTok{:}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Intercept"}\NormalTok{, }\StringTok{"X"}\NormalTok{)}
  \NormalTok{data2viz$algorithm <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(data2viz$algorithm, }\DataTypeTok{levels =} \KeywordTok{rev}\NormalTok{(}\KeywordTok{levels}\NormalTok{(data2viz$algorithm)))}
  \KeywordTok{ggplot}\NormalTok{()+}
\StringTok{    }\KeywordTok{geom_path}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \NormalTok{data2viz$X,}
                  \DataTypeTok{y =} \NormalTok{data2viz$Intercept,}
                  \DataTypeTok{col =} \NormalTok{data2viz$algorithm,}
                  \DataTypeTok{group =} \NormalTok{data2viz$algorithm), }\DataTypeTok{size =} \DecValTok{1}\NormalTok{) +}
\StringTok{    }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\KeywordTok{as.vector}\NormalTok{(}\KeywordTok{round}\NormalTok{(}\KeywordTok{coefficients}\NormalTok{(}\KeywordTok{glm}\NormalTok{(y~x,}
                          \DataTypeTok{family =} \StringTok{'binomial'}\NormalTok{)), }\DecValTok{2}\NormalTok{)[}\DecValTok{2}\NormalTok{]),}
                   \KeywordTok{as.vector}\NormalTok{(}\KeywordTok{round}\NormalTok{(}\KeywordTok{coefficients}\NormalTok{(}\KeywordTok{glm}\NormalTok{(y~x,}
                          \DataTypeTok{family =} \StringTok{'binomial'}\NormalTok{)), }\DecValTok{2}\NormalTok{)[}\DecValTok{1}\NormalTok{])),}
               \DataTypeTok{col =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}\NormalTok{, }\DataTypeTok{shape =} \DecValTok{15}\NormalTok{) +}
\StringTok{    }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{XX, }\DataTypeTok{y=}\NormalTok{YY),}
               \DataTypeTok{col =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{4}\NormalTok{, }\DataTypeTok{shape =} \DecValTok{17}\NormalTok{) +}
\StringTok{    }\KeywordTok{theme_bw}\NormalTok{(}\DataTypeTok{base_size =} \DecValTok{20}\NormalTok{) +}
\StringTok{    }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{panel.border =} \KeywordTok{element_blank}\NormalTok{(),}
          \DataTypeTok{legend.key =} \KeywordTok{element_blank}\NormalTok{()) +}
\StringTok{    }\KeywordTok{scale_colour_brewer}\NormalTok{(}\DataTypeTok{palette=}\StringTok{"Set1"}\NormalTok{, }\DataTypeTok{name =} \StringTok{'Algorithm'}\NormalTok{) +}
\StringTok{    }\KeywordTok{xlab}\NormalTok{(}\StringTok{'X'}\NormalTok{) +}\KeywordTok{ylab}\NormalTok{(}\StringTok{'Intercept'}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}